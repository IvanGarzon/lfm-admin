generator client {
  provider        = "prisma-client-js"
  output          = "./generated/client"
}

datasource db {
  provider = "postgresql"
}

generator zod {
  provider                  = "zod-prisma-types"
  output                    = "./zod"
  prismaClientPath          = "@/prisma/client"
  createRelationValuesTypes = true
  writeBarrelFiles          = true
  writeNullishInModelTypes  = true
  createInputTypes          = true
  useMultipleFiles          = true
  useTypeAssertions         = false
  useDecimalJs              = true
}

generator json {
  provider = "prisma-json-types-generator"
}

model Account {
  id                String  @id @default(cuid())
  userId            String  @map(name: "user_id")
  type              String
  provider          String
  providerAccountId String  @map(name: "provider_account_id")
  refreshToken      String? @map(name: "refresh_token") @db.Text
  accessToken       String? @map(name: "access_token") @db.Text
  expiresAt         Int?    @map(name: "expires_at")
  tokenType         String? @map(name: "token_type")
  scope             String?
  idToken           String? @map(name: "id_token") @db.Text
  sessionState      String? @map(name: "session_state")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map(name: "accounts")
}

model User {
  id            String    @id @default(cuid())
  firstName     String    @map(name: "first_name")
  lastName      String    @map(name: "last_name")
  email         String?   @unique
  emailVerified DateTime? @map(name: "email_verified") @db.Timestamptz()
  avatarUrl     String?   @map(name: "avatar_url")
  password      String?
  accounts      Account[]
  sessions      Session[]

  // role                  UserRole               @default(User)
  // isTwoFactorEnabled    Boolean                @default(false)
  // twoFactorConfirmation TwoFactorConfirmation?

  @@map(name: "users")
}

model Product {
  id          String        @id @default(cuid())
  imageUrl    String?       @map(name: "image_url")
  name        String
  description String?
  status      ProductStatus @default(ACTIVE)
  price       Decimal       @default(0) @db.Decimal(15, 2)
  stock       Int           @default(0)
  createdAt   DateTime      @default(now()) @map(name: "created_at") @db.Timestamptz()
  updatedAt   DateTime      @default(now()) @updatedAt @map(name: "updated_at") @db.Timestamptz()
  availableAt DateTime?     @map(name: "available_at") @db.Timestamptz()

  invoiceItems InvoiceItem[]
  quoteItems   QuoteItem[]

  @@map(name: "products")
}

model Customer {
  id             String         @id @default(cuid())
  firstName      String         @map(name: "first_name")
  lastName       String         @map(name: "last_name")
  gender         Gender
  email          String         @unique
  phone          String?
  status         CustomerStatus @default(ACTIVE)
  organizationId String?        @map(name: "organization_id")
  organization   Organization?  @relation(fields: [organizationId], references: [id])
  createdAt      DateTime       @default(now()) @map(name: "created_at") @db.Timestamptz()
  updatedAt      DateTime       @updatedAt @map(name: "updated_at") @db.Timestamptz()
  deletedAt      DateTime?      @map(name: "deleted_at") @db.Timestamptz()

  invoices Invoice[]
  quotes   Quote[]

  @@map(name: "customers")
}

model Organization {
  id        String     @id @default(cuid())
  name      String
  address   String?
  city      String?
  state     States?
  postcode  String?
  country   String?    @default("Australia")
  customers Customer[]
  createdAt DateTime   @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt DateTime   @updatedAt @map("updated_at") @db.Timestamptz()

  @@map(name: "organizations")
}

model Employee {
  id        String         @id @default(cuid())
  firstName String         @map(name: "first_name")
  lastName  String         @map(name: "last_name")
  email     String         @unique
  phone     String
  gender    Gender?
  dob       DateTime?      @db.Date()
  rate      Float          @default(0)
  status    EmployeeStatus @default(ACTIVE)
  avatarUrl String?        @map(name: "avatar_url")
  createdAt DateTime       @default(now()) @map(name: "created_at") @db.Timestamptz()
  updatedAt DateTime       @default(now()) @updatedAt @map(name: "updated_at") @db.Timestamptz()

  @@index([email])
  @@map(name: "employees")
}

model Audit {
  id        String     @id @default(uuid())
  userId    String?    @map(name: "user_id")
  tag       String
  event     String
  message   String
  data      Json?
  level     AuditLevel @default(INFO) // INFO | WARN | ERROR
  createdAt DateTime   @default(now()) @map(name: "created_at") @db.Timestamptz()

  @@map(name: "audit")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map(name: "session_token")
  userId       String   @map(name: "user_id")
  expires      DateTime @db.Timestamptz()

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  ipAddress String? @map(name: "ip_address") @db.Text
  userAgent String? @map(name: "user_agent") @db.Text
  isActive  Boolean @default(true) @map(name: "is_active")

  deviceName     String? @map(name: "device_name")
  deviceType     String? @map(name: "device_type")
  deviceVendor   String? @map(name: "device_vendor")
  deviceModel    String? @map(name: "device_model")
  osName         String? @map(name: "os_name")
  osVersion      String? @map(name: "os_version")
  browserName    String? @map(name: "browser_name")
  browserVersion String? @map(name: "browser_version")
  country        String?
  region         String?
  city           String?
  latitude       Float?
  longitude      Float?

  createdAt DateTime @default(now()) @map(name: "created_at") @db.Timestamptz()
  updatedAt DateTime @default(now()) @map(name: "updated_at") @db.Timestamptz()

  @@map(name: "sessions")
}

model Invoice {
  id            String @id @default(cuid())
  invoiceNumber String @unique @map(name: "invoice_number")

  customerId String   @map(name: "customer_id")
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Restrict)

  status InvoiceStatus @default(DRAFT)

  amount     Decimal  @db.Decimal(15, 2)
  currency   String   @default("AUD")
  discount   Decimal  @default(0) @db.Decimal(15, 2)
  gst        Decimal  @default(10) @map(name: "gst") @db.Decimal(5, 2)
  issuedDate DateTime @map(name: "issued_date") @db.Date
  dueDate    DateTime @map(name: "due_date") @db.Date

  remindersSent Int? @default(0) @map(name: "reminders_sent")

  paidDate      DateTime? @map(name: "paid_date") @db.Date
  paymentMethod String?   @map(name: "payment_method")

  cancelledDate DateTime? @map(name: "cancelled_date") @db.Date
  cancelReason  String?   @map(name: "cancel_reason")

  notes String? @db.Text

  items     InvoiceItem[]
  documents Document[]

  createdAt DateTime  @default(now()) @map(name: "created_at") @db.Timestamptz()
  updatedAt DateTime  @updatedAt @map(name: "updated_at") @db.Timestamptz()
  deletedAt DateTime? @map(name: "deleted_at") @db.Timestamptz()

  @@index([customerId])
  @@index([status])
  @@index([issuedDate])
  @@map(name: "invoices")
}

model InvoiceItem {
  id String @id @default(cuid())

  invoiceId String  @map(name: "invoice_id")
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  description String
  quantity    Int
  unitPrice   Decimal @map(name: "unit_price") @db.Decimal(15, 2)
  total       Decimal @db.Decimal(15, 2)

  productId String?  @map(name: "product_id")
  product   Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now()) @map(name: "created_at") @db.Timestamptz()
  updatedAt DateTime @updatedAt @map(name: "updated_at") @db.Timestamptz()

  @@index([invoiceId])
  @@map(name: "invoice_items")
}

model Quote {
  id          String   @id @default(cuid())
  quoteNumber String   @unique @map(name: "quote_number")
  customerId  String   @map(name: "customer_id")
  customer    Customer @relation(fields: [customerId], references: [id], onDelete: Restrict)

  status QuoteStatus @default(DRAFT)

  versionNumber  Int     @default(1) @map(name: "version_number")
  parentQuoteId  String? @map(name: "parent_quote_id")
  parentQuote    Quote?  @relation("QuoteVersions", fields: [parentQuoteId], references: [id], onDelete: Restrict)
  versions       Quote[] @relation("QuoteVersions")

  amount     Decimal  @db.Decimal(15, 2)
  currency   String   @default("AUD")
  gst        Decimal  @default(10) @db.Decimal(5, 2)
  discount   Decimal  @default(0) @db.Decimal(15, 2)
  issuedDate DateTime @map(name: "issued_date") @db.Date
  validUntil DateTime @map(name: "valid_until") @db.Date

  invoiceId String? @unique @map(name: "invoice_id")
  notes String? @db.Text
  terms String? @db.Text

  items         QuoteItem[]
  documents     Document[]
  attachments   QuoteAttachment[]
  statusHistory QuoteStatusHistory[]

  createdAt DateTime  @default(now()) @map(name: "created_at") @db.Timestamptz()
  updatedAt DateTime  @updatedAt @map(name: "updated_at") @db.Timestamptz()
  deletedAt DateTime? @map(name: "deleted_at") @db.Timestamptz()

  @@index([customerId])
  @@index([status])
  @@index([issuedDate])
  @@map(name: "quotes")
}

model QuoteItem {
  id      String @id @default(cuid())
  quoteId String @map(name: "quote_id")
  quote   Quote  @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  description String
  quantity    Int
  unitPrice   Decimal @map(name: "unit_price") @db.Decimal(15, 2)
  total       Decimal @db.Decimal(15, 2)
  order       Int     @default(0) // Display order within the quote

  // Optional product reference
  productId String?  @map(name: "product_id")
  product   Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  // Item-level attachments (flower arrangement photos)
  attachments QuoteItemAttachment[]

  // Color palette (array of hex color codes, max 10 colors)
  colors String[] @default([])

  // Notes for this quote item (describing the images/attachments)
  notes String? @db.Text

  createdAt DateTime @default(now()) @map(name: "created_at") @db.Timestamptz()
  updatedAt DateTime @updatedAt @map(name: "updated_at") @db.Timestamptz()

  @@index([quoteId])
  @@index([quoteId, order])
  @@map(name: "quote_items")
}

model QuoteAttachment {
  id      String @id @default(cuid())
  quoteId String @map(name: "quote_id")
  quote   Quote  @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  fileName String @map(name: "file_name")
  fileSize Int    @map(name: "file_size")
  mimeType String @map(name: "mime_type")
  s3Key    String @unique @map(name: "s3_key")
  s3Url    String @map(name: "s3_url")

  uploadedBy String?  @map(name: "uploaded_by")
  uploadedAt DateTime @default(now()) @map(name: "uploaded_at") @db.Timestamptz()

  @@index([quoteId])
  @@map(name: "quote_attachments")
}

model QuoteItemAttachment {
  id          String    @id @default(cuid())
  quoteItemId String    @map(name: "quote_item_id")
  quoteItem   QuoteItem @relation(fields: [quoteItemId], references: [id], onDelete: Cascade)

  fileName String @map(name: "file_name")
  fileSize Int    @map(name: "file_size")
  mimeType String @map(name: "mime_type")
  s3Key    String @map(name: "s3_key")
  s3Url    String @map(name: "s3_url")

  uploadedBy String?  @map(name: "uploaded_by")
  uploadedAt DateTime @default(now()) @map(name: "uploaded_at") @db.Timestamptz()

  @@index([quoteItemId])
  @@index([s3Key])
  @@map(name: "quote_item_attachments")
}

model QuoteStatusHistory {
  id             String      @id @default(cuid())
  quoteId        String      @map(name: "quote_id")
  quote          Quote       @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  status         QuoteStatus
  previousStatus QuoteStatus?
  changedAt      DateTime    @default(now()) @map(name: "changed_at") @db.Timestamptz()
  changedBy      String?     @map(name: "changed_by")
  notes          String?     @db.Text

  @@index([quoteId, changedAt])
  @@map(name: "quote_status_history")
}

model Document {
  id String @id @default(cuid())

  kind DocumentKind @map("kind")

  invoiceId String?  @map("invoice_id")
  invoice   Invoice? @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  quoteId String? @map("quote_id")
  quote   Quote?  @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  fileHash String @map("file_hash")
  fileName String @map("file_name")
  fileSize Int    @map("file_size")
  mimeType String @default("application/pdf") @map("mime_type")
  s3Key    String @unique @map("s3_key")
  s3Url    String @map("s3_url")

  generatedAt    DateTime @default(now()) @map("generated_at") @db.Timestamptz()
  lastAccessedAt DateTime @default(now()) @map("last_accessed_at") @db.Timestamptz()

  metadata Json?

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz()

  @@index([invoiceId])
  @@index([quoteId])
  @@map("documents")
}


enum Gender {
  MALE
  FEMALE
}

enum EmployeeStatus {
  ACTIVE
  INACTIVE
}

enum CustomerStatus {
  ACTIVE
  INACTIVE
  DELETED
}

enum ProductStatus {
  ACTIVE
  INACTIVE
  OUT_OF_STOCK
}

enum States {
  ACT
  NSW
  NT
  QLD
  SA
  TAS
  VIC
  WA
}

enum AuditLevel {
  INFO  @map(name: "info")
  WARN  @map(name: "warn")
  ERROR @map(name: "error")
}

enum InvoiceStatus {
  PENDING
  PAID
  CANCELLED
  OVERDUE
  DRAFT
}

enum QuoteStatus {
  DRAFT
  SENT
  ON_HOLD
  ACCEPTED
  REJECTED
  EXPIRED
  CANCELLED
  CONVERTED
}

enum DocumentKind {
  INVOICE
  RECEIPT
  QUOTE
}

